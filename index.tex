\def\Bun{{\rm Bun}}

\section{Formal index theorem on the moduli of $G$-bundles}

Suppose $X$ is a complex curve and $G$ is a simple Lie group.
If $x \in X$, denote by $\Hat{\sO}_x$ the completed local ring at $x$ which is non-canonically isomorphic to the ring of power series $\CC[[t]]$. 
Let $\Hat{\sK}_x$ denote its field of fractions, which can be identified with Laurent series $\CC((t))$. 
The corresponding formal disk and formal punctured disk are denoted by $\Hat{D}_x = {\rm Spec}(\Hat{\sO}_x)$, $\Hat{D}_x^{\times} = {\rm Spec}(\Hat{\sK}_x)$.
Let $G(\Hat{\sO}_x)$ be the group of maps $\Hat{D}_x \to G$ and $G(\Hat{\sK}_x)$ be the group of maps $\Hat{D}_x^\times \to G$. 
The latter is sometimes called the formal loop group of $G$. 

There is a subgroup $G_{\rm out}$ of $G(\Hat{\sK}_x)$ consisting of the maps $X \setminus x \to G$.
A result of \brian{ref} identifies the moduli space of $G$-bundles on $X$ with the double quotient
\ben
{\rm Bun}_G(X) \cong G_{\rm out} ?? G(\Hat{\sK}_x) / G(\Hat{\sO}_x) .
\een

Let ${\rm Bun}_{G}(X)$ denote the moduli space of $G$-bundles on the complex $d$-fold $X$. 
For $d > 1$ \cite{FHK} have constructed a global smooth derived realization of this space, but its full structure will not be used in this discussion. 
We recall the definition of the determinant line bundle associated to a representation as a functor
\ben
\kappa : {\rm Rep}(G) \to {\rm Pic}(\Bun_G(X)) .
\een

Consider the universal $G$-bundle $\sB {\rm un}_G(X)$ over the space $\Bun_G(X) \times X$ whose fiber over $\{P \to X\} \times X$ is equal to the bundle $P$ itself:
\ben
\xymatrix{
P \ar[r] \ar[d] & \sB {\rm un}_G(X) \ar[d]^G \\
\{P\} \times X \ar[r] & \Bun_G(X) \times X .
}
\een
Given a representation $V$ consider the associated vector bundle $\sV = \sB {\rm un}_G(X) \times^G V$ over $\Bun_G(X) \times X$. 
If $p_1 : \Bun_G(X) \times X \to \Bun_G(X)$ is the projection, the determinant line bundle associated to $V$ is defined by
\ben
\kappa_V := \det (\RR p_{1*} \sV)
\een
where $\RR p_{1*}$ is the derived pushforward, and the determinant is interpreted in the graded sense.
For instance, if $W = W_0 + W_1 [-1]$ is a graded vector space concentrated in degree zero and one then $\det(W) = \det(W_0) \tensor \det(W_1)^{-1}$.

\subsection{Symmetries of BV theories}

First, we review what symmetries look like in classical mechanics. 
Let $\fg$ be a Lie algebra and $(M, \omega)$ a symplectic manifold. 
A symplectic action of $\fg$ on $M$ is a map of Lie algebras $\rho : \fg \to {\rm Vect}^{\rm symp}(M, \omega)$, where the target is the Lie algebra of symplectic vector fields. 
Let $\sO(M)$ be the commutative algebra of smooth functions on $M$.
An action of the Lie algebra $\fg$ on $M$ induces a map of Lie algebras $\rho : \fg \to {\rm Der}(\sO(M))$ by derivations. 
The Poisson bracket $\{-,-\}$ on functions also determines a map of Lie algebras $\sO(M) \to {\rm Der}(\sO(M))$ sending $f \mapsto \{f,-\}$. 
The symplectic action is {\em Hamiltonian} if there exists a lifting $\Tilde{\rho} : \fg \to C^\infty(M)$.

A classical field theory is determined by an (infinite-dimensional) space of fields with a shifted symplectic structure. 
We recall how ...

\subsubsection{Classical symmetries}

In the BV formalism, the data of a classical field theory on $X$ consists of a sheaf of fields $\sE$, an action functional $S \in \oloc(\sE)$ of degree zero, and a $(-1)$-shifted $\CC$-valued pairing on $\sE$. 
The pairing induces a bracket $\{-,-\}$ on the space of local functionals, and this data is required to satisfy the condition $\{S,S\} = 0$.
This is known as the {\em classical master equation}. 

Alternatively, we can view the shifted space of local functionals $\oloc(\sE)$ as a dg Lie algebra. 
The differential is $\{S,-\}$ and the Lie bracket is $\{-,-\}$. 
The classical master equation is equivalent to the statement that $S$ is a Maurer--Cartan element of this dg Lie algebra. 

Let $\sL$ be a local Lie algebra on $X$. 
Then, $\sL(X)$ is an $L_\infty$ algebra and we can consider its reduced Chevalley--Eilenberg cochain complex $\cred^*(\sL(X))$.
This is a commutative dg algebra, so we can tensor with $\oloc(\sE)[-1]$ to form the new dg Lie algebra $\cred^*(\sL(X)) \tensor \oloc(\sE)[-1]$. 
The differential is of the form $\d_{\sL} + \{S,-\}$, where $\d_{\sL}$ is the CE differential for $\sL(X)$, and the bracket is $\id_\sL \tensor \{-,-\}$.

\begin{dfn}
Let $\sL$ be a local Lie algebra and $(\sE, S)$ a classical theory.
Define the dg Lie algebra 
\ben
{\rm Act}(\sL, \sE) := \cloc^*(\sL) \tensor \oloc(\sE) / \left(\cloc^*(\sL) \oplus \oloc(\sE) \right) 
\een
with differential and bracket given by the restriction of $\d_{\sL} + \{S,-\}$ and $\{-,-\}$, respectively.
\end{dfn}

Note that ${\rm Act}(\sL, \sE) \subset \cred^*(\sL(X)) \tensor \oloc(\sE)[-1]$ is an inclusion of dg Lie algebras.
A functional $F \in \cred^*(\sL(X)) \tensor \oloc(\sE)[-1]$ lives in ${\rm Act}(\sL, \sE)$ if and only if:
\begin{itemize}
\item[(1)] As a functional of $\sL$, $F$ is {\em local}, and
\item[(2)] The functional $S^{\sL}$ must depend on both $\sL$ and $\sE$. We mod out by functionals that are of purely one or the other. 
\end{itemize}

We can now define what it means for a local Lie algebra to be a symmetry.

\begin{dfn} Suppose $\sL$ is a local Lie algebra and $(\sE, S)$ defines a classical theory.
An {\em $\sL$-symmetry} of $\sE$ is a functional $S^{\sL} \in {\rm Act}(\sL, \sE)$ that satisfies the {\em $\sL$-equivariant classical master equation}:
\ben
\d_\sL S^{\sL} + \{S, S^{\sL}\} + \frac{1}{2} \{S^{\sL}, S^{\sL}\} = 0 .
\een
\end{dfn}

Such an element $S^{\sL}$ is automatically a Maurer--Cartan element of the dg Lie algebra $\cred^*(\sL(X)) \tensor \oloc(\sE)[-1]$.
By the general yoga of Koszul duality, a Maurer--Cartan element defines a map of $L_\infty$ algebras 
\ben
S^{\sL} : \sL(X) \to \oloc(\sE)[-1] .
\een
\brian{compare to finite dimensional case}

\subsubsection{Quantum symmetries}

We now discuss symmetries of a quantum field theory.
From the data of such a quantum symmetry is a local cocycle on the $L_\infty$ algebra that we interpret as a type of ``local index".

We follow the approach of Costello \cite{Cosbook} to perturbative QFT based on the Wilsonian renormalization of the path integral.
We start with a space of fields $\sE$ equipped with a square zero elliptic differential operator $Q$ of cohomological degree zero, and a $(-1)$-shifted symplectic pairing.
This is the data of a {\em free} theory in the classical BV formalism.
A QFT is a family of functionals $\{S[L]\}$ ...

The main result of \cite{CG2} says that associated to any QFT $(\sE, S^\q)$ defined on $X$ there is a factorization algebra $\Obs^\q$ on $X$ called the {\em quantum observables}. 

\begin{thm}[\cite{CG2} Theorem 12.5.0.1]
Suppose we have an $\sL$-symmetry of a QFT $(\sE, S^\q)$. 
Then, there is a cohomology class $\alpha_\sE \in H^1_{red,loc}(\sL)[[\hbar]]$ such that the factorization Lie algebra $\sL_c$ acts (up to homotopy) on the factorization algebra of quantum observables $\Obs_{\sE}^\q[\hbar^{-1}]$ by $\alpha_\sE$ times the identity.
\end{thm}

We will call $\alpha_{\sE}$ the {\em anomaly cocycle} corresponding to the $\sL$-symmetry.
This cocycle $\alpha = \alpha_{\sE}$ can be viewed as the ``local character" for the action of the local Lie algebra $\sL$ on the observables.
Indeed, this statement implies that for any open set $U \subset X$ we have an action of the $L_\infty$ algebra $\sL_c(U)$ on $\Obs^\q(U)[\hbar^{-1}]$, and that this action is homotopy equivalent to the trivial action times the character $\alpha$. 
Moreover, this homotopy equivalence is compatible with the factorization structure. 

There is a convincing way to repackage this action of $\sL_c$ on the quantum observables. 
Let $\Obs^\q_{\alpha}$ denote the $\sL_c$-equivariant factorization algebra
\ben
\Obs^\q \tensor_{\CC[[\hbar]]} {\ul \CC}_\alpha [[\hbar]]
\een
where $\CC_\alpha[[\hbar]]$ denotes the $\CC[[\hbar]]$-linear constant factorization algebra with action of $\sL_c$ given by the character $\alpha$. 
The theorem implies that there is a quasi-isomorphism of factorization algebras
\ben
\clieu_*(\sL_c, \Obs^\q_\alpha)[\hbar^{-1}] \simeq \clieu_*(\sL_c) \tensor \Obs^\q[\hbar^{-1}] .
\een

There is a natural augmentation map of factorization algebras $\epsilon : \clieu_*(\sL_c) \to \ul{\CC}$ that projects onto the $\Sym^0$ component. 
Furthermore, the unit observable $\mathbb{1} : \ul{\CC} \to \Obs^\q$ defines a map of factorization algebras
\ben 
\mathbb{1} : \clieu_*(\sL_c, \ul{\CC}_\alpha[[\hbar]]) \to \clieu_*(\sL_c, \Obs^\q_\alpha) .
\een

\begin{thm}[\cite{CG2}] \label{thm noether} The composition defines a sequence of maps of factorization algebras
\ben
\clieu_*(\sL_c, \CC_\alpha[[\hbar]]) \xto{\mathbb{1}} \clieu_*(\sL_c, \Obs^\q_\alpha)[\hbar^{-1}] \simeq \clieu_*(\sL_c) \tensor \Obs^\q[\hbar^{-1}] \xto{\epsilon} \Obs^\q [\hbar^{-1}] .
\een
In summary, there is a map of factorization algebras
\ben
\Phi : \clieu_{*,\alpha} (\sL_c) \to \Obs^\q [\hbar^{-1}]
\een
where $\clieu_{*,\alpha}(\sL)$ is the $\CC[[\hbar]]$-linear twisted factorization envelope of $\sL$ by $\alpha$. 
\end{thm}

In the remainder of this section we interpret the implication of this for the Kac--Moody 

\subsection{The anomaly for the $\beta\gamma$ system}

\subsubsection{The quantization of free BV theories}

\brian{statement about determinants a la Gwilliam-Haugseng}

\subsubsection{}

We now introduce the higher dimensional free $\beta\gamma$ system. 
This is a free BV theory defined on any complex $d$-fold $X$.
Let $V$ be a finite dimensional vector space. 
The fields are defined as 
\ben
\sE(X, V) = \Omega^{0,*}(X) \tensor V \oplus \Omega^{d,*}(X) \tensor V^\vee [d-1] .
\een 
We denote a general field by $(\gamma, \beta)$ according to the above decomposition. 
The action is 
\ben
S(\gamma, \beta) = \int_X \<\beta, \dbar \gamma\>
\een
where the brackets $\<-,-\>$ denote the obvious pairing between $V$ and its dual. 


Now, we are ready to state the main result about the anomaly cocycle for the Kac--Moody symmetry of the higher dimensional $\beta\gamma$ system.

\begin{thm} Let $V$ be a finite dimensional $\fg$-module and $X$ any complex $d$-fold.
There exists a one-loop exact $\fg^X$-symmetry of the quantum $\beta\gamma$ system valued in $V$ quantizing the natural classical $\fg^X$-symmetry.
Moreover, the anomaly cocycle $\alpha_V \in H^1_{\rm loc}(\fg^X)$ is identified with the image of $$\#\ch_{d+1}(V) \in \Sym^{d+1}(\fg^\vee)^\fg$$ under the map $J : \Sym^{d+1}(\fg^\vee)^\fg [-1] \to \cloc^*(\fg^X)$. 
\end{thm}

As a simple corollary, we find the anomaly in a slightly more general situation.

\begin{cor} Let $P$ be a principal $G$-bundle on $X$, and $V$ a $G$-representation. 
Then we can consider the $\fg^X_P = \Omega^{0,*}(X ; {\rm ad}(P))$-equivariant theory
\ben
\sE_{P \to X, V} = T^*[-1] (\Omega^{0,*}(X ; P \times^G V)) .
\een
This theory admits a canonical $\fg^X_P$-equivariant quantization. 
Moreover, the cohomology class of the obstruction $[\Theta_{V}]$ to an inner action is also identified with $\#\ch_{d+1}(V)$. 
\end{cor}

We will prove the proposition in the following steps. 
First, we argue that it suffices to calculate this obstruction on an arbitrary open set in $X$. 
Taking this open set to be a disk we see that it is enough to compute the cocycle in the case that $X = \CC^d$. 
In this case, we find a quantization that is actually finite at the one-loop level. 
This means that there are no counterterms necessary, and we can explicitly calculate the cocycle in terms of the weight of a  simple one-loop Feynman diagram.

\subsubsection{The reduction to a disk}

By construction, the data of a classical BV theory on $X$ is sheaf-like on the manifold. That is, we have a sheaf of $(-1)$-shifted elliptic complexes $\sE$ on $X$ together with a local functional $I \in \oloc(\sE)(X)$. The space of local functionals $\oloc(\sE)$ also forms a sheaf on $X$, so it makes sense to restrict $I$ to any open set $U \subset X$. In this way, for each open we have a $(-1)$-shifted elliptic complex $\sE(U)$ together with a local functional $I |_{U}\in \oloc(\sE)(U)$ -- that is, a classical field theory on $U \subset X$. A fancy way of saying this is that the space of classical field theories on $X$ forms a sheaf. 

A very slightly refined version of this takes into account an action of a local Lie algebra. If $\sL$ is a local Lie algebra on $X$ then the space of $\sL$-equivariant classical BV theories also forms a sheaf on $X$. 

Costello has shown in \cite{cosren} that the space of quantum field theories also form a sheaf on $X$. In a completely analogous way, one can show that the space of $\sL$-equivariant quantum field theories forms a sheaf on $X$. 

We have already seen how the obstruction to lifting a quantum field theory with an action of a local Lie algebra $\sL$ to an inner action arises as a failure of satisfying the QME. Since an $\sL$-equivariant theory satisfies the QME modulo terms in $\cloc^*(\sL)(X)$, this obstruction $\Theta(X)$is a degree one cocycle in $\cloc^*(\sL)(X)$. By the remarks above, we can restrict any $\sL$-equivariant field theory to an arbitrary open set $U \subset X$. Hence, for each open $U \subset X$ we have an obstruction element $\Theta^U$. The complex $\cloc^*(\sL)(X)$ also has a refinement to a sheaf of complexes on $X$ and the obstruction $\Theta^U$ is an element in $\cloc^*(\sL)(U)$. We will need the following elementary fact that the obstruction to having an inner action is natural with respect to the restriction of open sets.

\begin{lem} Let $i_U^V : U \hookrightarrow V$ be any inclusion of open sets in $X$. Then
\ben
(i_U^V)^* ([\Theta^V]) = [\Theta^U]
\een
where $(i_U^V)^* : \cloc^*(\sL)(V) \to \cloc^*(\sL)(U)$ is the restriction map and the brackets $[-]$ denotes the cohomology class of the cocycle. In other words, the map that sends a quantum field theory on $X$ with an $\sL$-action to its obstruction to having an inner $\sL$-action is a map of sheaves. 
\end{lem}

For any complex $d$-fold $X$ we have defined the map $J^X : {\rm Sym}^{d+1}(\fg^\vee)^\fg \to \cloc^*(\fg^X)$. The complex $\cloc^*(\fg^X)$

\begin{lem} The map 
\ben
J : \ul{\Sym^{d+1} (\fg^\vee)^\fg} \to \cloc^*(\fg^X)
\een
defined on each open by $J|_{U} = J^U$ is a map of sheaves. Here, the underline means the constant sheaf. 
\end{lem} 

\begin{lem} For any open sets $i_{U}^V : U \subset V$ in $X$ the induced map
\ben
(i_U^V)^* : H^1\left(V ; \cloc^*(\fg^X)\right) \to H^1\left(U ; \cloc^*(\fg^X)\right)
\een
is injective.
\end{lem}


\brian{The last key observation is that $(i_U^V)^* J^V = J^U$.}


\subsubsection{The theory on a disk}

\subsubsection{The Heisenberg algebra}

In ordinary classical mechanics, the Heisenberg algebra is a convenient tool to construct the deformation quantization for quadratic Hamiltonians.
This construction carries over for symplectic dg vector spaces.
We will use it to give a model for the sphere observables of the $\beta\gamma$ system.
Furthermore, we provide a map from the sphere Lie algebra $\Hat{\fg}_{d, \theta}$ to a completion of this algebra as a corollary of the Theorem \ref{thm noether}.

Let $A_d$ be the commutative dg algebra from Section \ref{sec lie} and $V$ a finite dimensional vector space. 
Consider the dg (0-shfted) symplectic vector space
\ben
W_d(V) = A_d \tensor V \oplus A_d \tensor V^\vee [d-1]
\een
with pairing defined by
\ben
\omega_W (a \tensor v, b \tensor v^\vee) = \<v, v^\vee\> \oint_{S^{2d-1}} a \wedge b 
\een
where $\oint_{S^{2d-1}}$ is the higher residue and $\<v,v^\vee\>$ denotes the pairing between $V$ and its dual. 
Clearly $\omega_W$ is non-degenerate and it is immediate to check that $\d \omega = 0$ where $\d$ is the differential on $A_d$, so that $\omega$ indeed defines a symplectic structure. 



